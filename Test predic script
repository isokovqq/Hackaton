# predict_default_model
import os
import joblib
import numpy as np
import pandas as pd

DATA_PATH = r"C:\Users\furqa\OneDrive\Desktop\python\merged_final_data.csv"  # change to your new dataset
MODEL_PATH = r"model_results\final_pd_model.joblib"
OUTPUT_PATH = "result.csv"

if not os.path.exists(MODEL_PATH):
    raise FileNotFoundError(f"Model not found at {MODEL_PATH}. Train first.")

artifacts = joblib.load(MODEL_PATH)

required = ["selected_features", "final_model_calibrated", "thresholds"]
for k in required:
    if k not in artifacts:
        raise KeyError(f"Artifact missing required key: '{k}'")

selected_features = artifacts["selected_features"]
selected_cat = artifacts.get("selected_cat", [])
imputer = artifacts.get("imputer", None)
model = artifacts["final_model_calibrated"]
thresholds = artifacts.get("thresholds", {})

thr_f1 = thresholds.get("best_f1", {}).get("threshold", 0.5)
thr_youden = thresholds.get("best_youden", {}).get("threshold", 0.5)

numeric_cols_model = [c for c in selected_features if c not in selected_cat]

df = pd.read_csv(DATA_PATH)
print("Loaded new dataset:", df.shape)

for col in selected_features:
    if col not in df.columns:
        df[col] = np.nan

for c in selected_cat:
    df[c] = df[c].astype(str).fillna("Missing")

if imputer is not None:
    if hasattr(imputer, "feature_names_in_"):
        imputer_cols = list(imputer.feature_names_in_)
        for c in imputer_cols:
            if c not in df.columns:
                df[c] = np.nan
        try:
            df[imputer_cols] = imputer.transform(df[imputer_cols])
        except Exception as e:
            if len(imputer_cols) == len(numeric_cols_model):
                for c in numeric_cols_model:
                    if c not in df.columns:
                        df[c] = np.nan
                df[numeric_cols_model] = imputer.transform(df[numeric_cols_model])
            else:
                print("Imputer transform failed; falling back to median fill for numeric model cols. Error:", e)
                df[numeric_cols_model] = df[numeric_cols_model].fillna(df[numeric_cols_model].median())
    else:
        try:
            for c in numeric_cols_model:
                if c not in df.columns:
                    df[c] = np.nan
            df[numeric_cols_model] = imputer.transform(df[numeric_cols_model])
        except Exception as e:
            print("Imputer.transform failed; falling back to median fill for numeric model cols. Error:", e)
            df[numeric_cols_model] = df[numeric_cols_model].fillna(df[numeric_cols_model].median())
else:
    df[numeric_cols_model] = df[numeric_cols_model].fillna(df[numeric_cols_model].median())

X_new = df[selected_features].copy()

try:
    probs = model.predict_proba(X_new)[:, 1]
except Exception as e:
    raise RuntimeError("Model prediction failed. Error: " + str(e))

pred_05 = (probs >= 0.5).astype(int)
pred_f1 = (probs >= thr_f1).astype(int)
pred_youden = (probs >= thr_youden).astype(int)

output = pd.DataFrame({
    "prob_default": probs,
    "pred_0.50": pred_05,
    f"pred_bestF1_{thr_f1:.2f}": pred_f1,
    f"pred_bestYouden_{thr_youden:.2f}": pred_youden
})

for id_col in ["customer_id", "application_id"]:
    if id_col in df.columns:
        output[id_col] = df[id_col]

output.to_csv(OUTPUT_PATH, index=False)
print(f"âœ… Predictions saved to {OUTPUT_PATH}")
print(output.head())
